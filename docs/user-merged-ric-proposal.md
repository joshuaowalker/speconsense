# Proposal: Improving RiC Reporting in Speconsense

## Background

If you're familiar with NGSpeciesID from the ONT fungal barcoding workflow, welcome! Speconsense is designed as a drop-in replacement with some key improvements. However, the architecture introduces a subtle issue with how we report read counts for merged consensus sequences.

**We're seeking feedback from the community on our proposed solution.** As experts running ONT sequencing labs for mycology work, your perspective is invaluable in ensuring this approach meets real-world needs. This document explains the issue and our proposed solution.

## Field Definitions: Understanding size= and ric=

Before we dive in, a quick note on the header fields:

- **`size=N`** - Total number of reads clustered together for this variant (clustering happens before sampling)
- **`ric=N`** - Reads in Consensus - actual reads used by SPOA to generate the consensus (may be less than size due to `--max-sample-size` sampling; typically a round number chosen by the user)

For example: `size=347 ric=100` means the cluster had 347 reads, but we sampled 100 of them to generate the consensus (because `--max-sample-size=100`).

## What You Might Have Noticed

Some users have observed that consensus sequences in their `__Summary__/` output have `ric` (Reads in Consensus) values that exceed the `--max-sample-size` parameter. For example:

```bash
# You ran with --max-sample-size 100
speconsense input.fastq --max-sample-size 100

# But in __Summary__/summary.fasta you see:
>specimen-A-1 size=497 ric=250 snp=2 primers=ITS1F,ITS4
```

**Question**: Why does `ric=250` when the maximum should be 100?

## How Speconsense Works: A Two-Stage Design

Unlike NGSpeciesID (which does everything in one step), Speconsense uses a two-stage design:

### Stage 1: speconsense (Core Clustering)

```bash
speconsense input.fastq --max-sample-size=100
```

**What it does:**
- Clusters your reads using MCL or greedy algorithm
- Generates a consensus sequence for each cluster using SPOA
- Respects `--max-sample-size=100` - never uses more than 100 reads for any single consensus
- Outputs: `clusters/{specimen}-all.fasta` with one consensus per cluster

**Output example:**
```
>specimen-A-c1 size=347 ric=100 primers=ITS1F,ITS4
>specimen-A-c2 size=89 ric=89 primers=ITS1F,ITS4
>specimen-A-c3 size=61 ric=61 primers=ITS1F,ITS4
```

Each consensus was generated from its own set of reads. All `ric` values are ≤100 ✓

### Stage 2: speconsense-summarize (Post-Processing)

```bash
speconsense-summarize
```

**What it does:**
- **SNP-based merging**: Combines clusters that differ by only a few SNPs into a single consensus with IUPAC ambiguity codes
- **Variant grouping**: Groups similar variants together
- **Variant selection**: Chooses which variants to output based on size or diversity
- Outputs: `__Summary__/` with final consensus sequences and consolidated FASTQ files

**Output example (current behavior):**
```
>specimen-A-1 size=497 ric=250 snp=2 primers=ITS1F,ITS4
```

This consensus was created by merging the three clusters above (c1+c2+c3) because they differed by only 2 SNP positions. The total ric (250 = 100+89+61) exceeds --max-sample-size (100).

## Why This Design?

**Why not merge during initial clustering?**

The two-stage design was chosen because it's cleaner conceptually and more flexible:
- Clustering and consensus generation are computationally expensive
- Variant management (merging, grouping, selection) is fast
- You can experiment with different merge thresholds (`--snp-merge-limit`, `--max-variants`) without re-running the slow clustering step
- Avoids creating many intermediate files and consensus regeneration stages

**Trade-off**: It creates the `ric` accumulation issue we're discussing.

## The Issue: What Does RiC Mean After Merging?

Here's the conceptual problem:

**Before merging** (from speconsense):
- `ric=100` means: "SPOA used 100 reads to generate this consensus sequence"
- The FASTQ file contains those 100 reads
- You could regenerate the consensus from the FASTQ

**After merging** (from speconsense-summarize):
- `ric=250` means: "Sum of ric values from 3 merged clusters (100+89+61)"
- The FASTQ file contains all 250 reads from all 3 clusters
- The consensus was NOT generated by running SPOA on 250 reads - it was generated by merging three existing consensus sequences using IUPAC codes

The number `250` represents **total supporting evidence**, not "reads used for consensus generation."

### Why This Matters

1. **Quality interpretation**: Users see `ric=250` and think "wow, very high quality!" when it's actually "3 normal-quality consensuses merged together"

2. **Filtering expectations**: If you filter for `ric >= 100`, you might get merged consensuses where one component had `ric=20`

3. **Comparison with --max-sample-size**: You expect all `ric ≤ 100` but see values exceeding it

## Proposed Solution: The merged_ric Field

We propose adding a new header field that makes merging transparent. We'd like your feedback on whether this approach would work for your workflows:

### New Header Format

**Merged consensus (proposed):**
```
>specimen-A-1 size=497 ric=250 merged_ric=100+89+61 snp=2 primers=ITS1F,ITS4
```

**Single-cluster consensus (unchanged):**
```
>specimen-B-1 size=113 ric=100 primers=ITS1F,ITS4
```

### What merged_ric Tells You

The `merged_ric=100+89+61` field shows:
- This consensus was created by merging **3 separate clusters**
- The original clusters had ric values of 100, 89, and 61 (shown largest-first)
- Total supporting reads: 250 (sum of the above)
- You can assess the **quality distribution**

### Interpreting merged_ric Values

**Balanced merge - High confidence:**
```
merged_ric=60+55+50  (ric=165)
```
Three similar-quality consensuses merged. Each had strong support independently (50+). Strong evidence this represents real biological variation.

**Acceptable merge - Good quality:**
```
merged_ric=30+20  (ric=50)
```
Two medium-quality consensuses. Both components have decent support (30, 20).

**Dominated merge - Scrutinize more carefully:**
```
merged_ric=100+8+5  (ric=113)
```
One strong cluster (100) plus two weak ones (8, 5). The merged consensus is mainly based on the first cluster. The weak clusters were less prominent in the source data.

**Questionable merge - Review needed:**
```
merged_ric=6+5+4+3  (ric=18, snp=2)
```
Four relatively weak consensuses (all <10). Even though total ric=18 seems okay, none of the individual haplotypes has strong support. 

**Missing merged_ric - Single cluster:**
```
size=113 ric=100 primers=ITS1F,ITS4
```
No merging occurred. This is a straightforward consensus from one cluster.

## Understanding the Philosophy: Ambiguity Codes as Information

This might seem like a technical detail, but it's worth understanding the conceptual approach we're taking:

### Traditional View: Ambiguity = Uncertainty

In many bioinformatics contexts, IUPAC ambiguity codes (R, Y, W, etc.) represent **uncertainty** - less information:
- "I'm not sure if this position is A or G, so I'll call it R"
- Ambiguity codes are often seen as lower quality

### Speconsense Approach: Ambiguity = Summarized Variation

In speconsense-summarize, we use IUPAC codes to represent **known variation** - *more* information:
- "I have strong evidence for both A and G alleles in the sample, so I'll call it R"
- The code R tells you that you have **two distinct haplotypes** present
- This is actually *additional information* about biological diversity, not uncertainty

### Why This Matters

When speconsense-summarize merges clusters that differ by SNPs:
- It's **preserving information** about within-specimen variation
- It's **summarizing multiple variants** into one sequence using IUPAC codes
- More reads are needed to confidently call both alleles

This is why `merged_ric` can exceed `--max-sample-size`: you need sufficient reads for **each haplotype** (e.g., 3 haplotypes × 50 reads each = 150 total), plus enough to detect the variants between them.

### Open Science and Reproducibility

An important principle guiding this design is **sufficiency for reproduction**. The FASTQ file, combined with the published methodology on [protocols.io](https://dx.doi.org/10.17504/protocols.io.dm6gpbm88lzp/v4), should be sufficient for anyone to reproduce the FASTA consensus sequences.

This means:
- **All supporting reads must be preserved** in the FASTQ files (not subsampled after merging)
- **The processing steps must be transparent** through the header fields
- **The methodology must be fully documented** and publicly accessible

The `merged_ric` field supports this principle by:
1. Making it clear that merging occurred (not hiding the multi-step process)
2. Showing the quality of each component (enabling assessment of the merge decision)
3. Preserving all reads in the FASTQ (maintaining the evidence trail)

Someone receiving your FASTA and FASTQ files could:
- See from `merged_ric=100+89+61` that three consensuses were merged
- Access all 250 reads from the FASTQ file
- Follow the published protocols.io methodology to understand how the merge was performed
- Reproduce your results or re-analyze with different parameters

This commitment to reproducibility is essential for community science and open mycology work. Does this align with your expectations for data sharing and reproducibility?

## Practical Implications

### When Should You Be Concerned?

**✓ Expected and fine:**
```
merged_ric=65+60+55  (balanced, all strong)
merged_ric=80+75  (two similar, both strong)
```

**⚠ Review carefully:**
```
merged_ric=100+12+8  (dominated by one cluster)
merged_ric=18+15+12+10+9+8  (many weaker clusters)
```

In dominated merges, the weak clusters have less support. You may want to confirm that they make biological sense.

### Adjusting Your Workflow

**If you want conservative merging:**
```bash
# No SNP merging
speconsense-summarize --snp-merge-limit 0

# Higher quality threshold per haplotype
speconsense-summarize --min-ric 20  # Only use clusters with ric ≥ 20
```

**If you want to capture variation:**
```bash
# More permissive SNP merging (current default)
speconsense-summarize --snp-merge-limit 2

# Allow more variants per specimen
speconsense-summarize --max-variants 3
```

## What About --max-sample-size?

### Current Semantics

`--max-sample-size=100` (typical value) in speconsense means:
- "For each cluster, use at most 100 reads to generate its consensus"
- Prevents SPOA from running on huge clusters (which is slow)
- Ensures manageable FASTQ file sizes in debug output

### After Merging

When speconsense-summarize merges clusters:
- The combined FASTQ file can exceed 100 reads
- This is by design: you want all the supporting evidence
- The `merged_ric` field makes this transparent

### Edge Case: When Merging Is Required

Consider a specimen with 4 real haplotypes, where you're using a stricter sampling limit to manage computational load:
- Each haplotype needs ~20 reads for decent quality
- In this example, the clusters happen to have 25, 22, 20, and 18 reads (all below the `--max-sample-size=50` threshold)
- Merged total: 25 + 22 + 20 + 18 = 85 reads

In this case, the merged consensus with `merged_ric=25+22+20+18` (ric=85) actually represents the minimum viable evidence for resolving 4 variants. The total exceeding `--max-sample-size` is **expected** because you're representing more biological information (4 haplotypes rather than 1). This illustrates why the merged FASTQ files appropriately contain more reads than the per-cluster sampling limit.

## Migration Notes

### For New Users

- Pay attention to the `merged_ric` field in your output
- Balanced merges (similar values) are good
- Dominated merges (one large, others small) deserve scrutiny
- Use `--snp-merge-limit` and `--min-ric` to control merging behavior

### For Existing Users

- Your existing workflows will continue to work
- The `merged_ric` field is new and optional
- Presence of `merged_ric` indicates SNP merging occurred
- Absence means single-cluster consensus (no merging)

### For Publication/GenBank

The header is self-contained and meaningful without additional context:

```
>specimen-A-1 size=497 ric=250 merged_ric=100+89+61 snp=2 primers=ITS1F,ITS4
```

A curator can understand:
- Total supporting reads: 250
- Represents 3 merged haplotypes with good support (100, 89, 61)
- 2 SNP positions vary (IUPAC codes in sequence)
- Primers: ITS1F and ITS4

## Questions?

### Why not resample to keep --max-sample-size limit?

We could randomly (or proportionally) sample 100 reads from the 250 total, but then:
- The FASTQ file wouldn't contain all the evidence
- You couldn't verify which reads contributed
- Information would be lost
- Reproducibility would be compromised

Better to keep all reads and make the merging transparent with `merged_ric`.

### Can I reconstruct the pre-merge consensuses?

The FASTQ file contains all reads from all pre-merge clusters. With additional tooling, you could:
1. Split the FASTQ by original cluster
2. Regenerate each consensus separately
3. See the pre-merge sequences

This is a "nice to have" feature that could be added with a sidecar file showing read groupings.

### Should I always merge SNPs?

It depends on your goals:

**Yes, merge if:**
- You want to represent within-specimen variation compactly
- You're okay with IUPAC codes in your consensus
- You want a single representative sequence per specimen

**No, don't merge if:**
- You want clean, unambiguous sequences
- You prefer separate consensuses for each haplotype
- You'll handle variants downstream in your analysis

Use `--snp-merge-limit 0` to disable SNP merging entirely.

### Secondary Question: When Should --min-ric Apply?

There's a related question we'd like your input on: **When should the `--min-ric` threshold be applied?**

**Current behavior:** `--min-ric` filters clusters **before** merging. Each individual cluster must have `ric >= min_ric` to be included.

For example, with `--min-ric=3`:
- Clusters with ric=5, ric=4, ric=3 all pass individually
- They could then merge to create: `merged_ric=5+4+3` (ric=12)

**Potential issue:** Consider this scenario:
```
merged_ric=6+5+4+3  (ric=18, snp=2)
```
All four components passed `--min-ric=3`, but individually they're all quite weak (all <10). The merged consensus might not be reliable despite having ric=18 total.

**Question for users:** Should we:

**Option A (current):** Apply `--min-ric` before merging only
- Simple and predictable
- Users can set `--min-ric=10` or higher to prevent weak merges
- Treats all clusters equally regardless of whether they'll be merged

**Option B:** Apply `--min-ric` only after merging
- Weak clusters *not* filtered before merging, allowing very weak individual clusters to be merged (e.g., clusters with `ric=2`, `ric=1`, `ric=2`)
- Merged results of these weak clusters could pass final check: `merged_ric=2+2+1` with total `ric=5` passes `--min-ric=5`
- Better success rate in final output, but individual haplotypes have very weak support

**What makes sense for your workflow?** Given that 10 reads is typically sufficient for a single haplotype, should the minimum be the same regardless of merging? 

## Summary

Our proposed `merged_ric` field would address the RiC interpretation problem by:
- Showing which consensuses are merged (vs single-cluster)
- Revealing the quality distribution across merged components
- Maintaining self-contained, meaningful headers
- Preserving all supporting evidence in FASTQ files
- Supporting reproducibility by making the processing transparent

This approach aligns with our philosophy of using IUPAC codes to represent **biological variation** (more information) rather than uncertainty (less information), while giving you the transparency to assess consensus quality accurately.

## We Need Your Feedback

As experts using speconsense for real mycology work, your input is critical:

1. **Does the `merged_ric` field make sense?** Would it help you interpret your results?

2. **Are there edge cases we haven't considered?** Given your experience with fungal specimens, are there scenarios where this approach would be problematic?

3. **Would you want additional information?** Should we include anything else in the header or provide additional files?

4. **Does the reproducibility principle resonate?** Is the goal of "FASTQ + methodology = reproducible FASTA" important for your work and data sharing?

5. **Alternative naming?** Would a different field name be clearer? (e.g., `ric_sources`, `merge_ric`, etc.)

Please share your thoughts, concerns, or suggestions. This is a proposal, not a final decision—we want to make sure the solution works for the community's needs.
