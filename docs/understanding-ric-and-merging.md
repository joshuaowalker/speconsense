# Understanding RiC and Variant Merging in Speconsense

This guide explains how Speconsense handles read counts and variant merging, particularly why RiC (Reads in Consensus) values can exceed the `--max-sample-size` parameter and how to interpret merged consensus sequences.

## Background: Field Definitions

Before diving in, let's clarify the header fields you'll see in output:

- **`size=N`** - Total number of reads clustered together for this variant (clustering happens before sampling)
- **`ric=N`** - Reads in Consensus - actual reads used by SPOA to generate the consensus (may be less than size due to `--max-sample-size` sampling)
- **`rawric=N+N+...`** - RiC values of the raw variants that were merged to create this consensus (only present when variants were merged)

For example: `size=347 ric=100` means the cluster had 347 reads, but we sampled 100 of them to generate the consensus (because `--max-sample-size=100`).

## The Question: Why Does RiC Exceed --max-sample-size?

You may observe consensus sequences in your `__Summary__/` output that have `ric` values exceeding the `--max-sample-size` parameter. For example:

```bash
# You ran with --max-sample-size 100
speconsense input.fastq --max-sample-size 100

# But in __Summary__/summary.fasta you see:
>specimen-A-1 size=497 ric=250 rawric=100+89+61 snp=2 primers=ITS1F,ITS4
```

**Question**: Why does `ric=250` when the maximum should be 100?

## How Speconsense Works: A Two-Stage Design

Unlike NGSpeciesID (which does everything in one step), Speconsense uses a two-stage design:

### Stage 1: speconsense (Core Clustering)

```bash
speconsense input.fastq --max-sample-size=100
```

**What it does:**
- Clusters your reads using MCL or greedy algorithm
- Generates a consensus sequence for each cluster using SPOA
- Respects `--max-sample-size=100` - never uses more than 100 reads for any single consensus
- Outputs: `clusters/{specimen}-all.fasta` with one consensus per cluster

**Output example:**
```
>specimen-A-c1 size=347 ric=100 primers=ITS1F,ITS4
>specimen-A-c2 size=89 ric=89 primers=ITS1F,ITS4
>specimen-A-c3 size=61 ric=61 primers=ITS1F,ITS4
```

Each consensus was generated from its own set of reads. All `ric` values are ≤100 ✓

### Stage 2: speconsense-summarize (Post-Processing)

```bash
speconsense-summarize
```

**What it does:**
- **HAC variant grouping**: Groups similar variants together (separates contaminants from primary targets)
- **MSA-based variant merging**: Combines variants within each group that differ by only a few SNPs/indels into a single consensus with IUPAC ambiguity codes
- **Variant selection**: Chooses which variants to output based on size or diversity
- Outputs: `__Summary__/` with final consensus sequences and consolidated FASTQ files

**Output example:**
```
>specimen-A-1 size=497 ric=250 rawric=100+89+61 snp=2 primers=ITS1F,ITS4
```

This consensus was created by merging the three clusters above (c1+c2+c3) because they differed by only 2 SNP positions. The total ric (250 = 100+89+61) exceeds `--max-sample-size` (100).

## Why This Design?

**Why not merge during initial clustering?**

The two-stage design was chosen because it's cleaner conceptually and more flexible:
- Clustering and consensus generation are computationally expensive
- Variant management (merging, grouping, selection) is fast
- You can experiment with different merge thresholds (`--merge-position-count`, `--select-max-variants`) without re-running the slow clustering step
- Avoids creating many intermediate files and consensus regeneration stages

**Trade-off**: It creates the RiC accumulation we're discussing.

## Understanding RiC After Merging

Here's the key conceptual distinction:

**Before merging** (from speconsense):
- `ric=100` means: "SPOA used 100 reads to generate this consensus sequence"
- The FASTQ file contains those 100 reads
- You could regenerate the consensus from the FASTQ

**After merging** (from speconsense-summarize):
- `ric=250` means: "Sum of RiC values from 3 merged clusters (100+89+61)"
- The FASTQ file contains all 250 reads from all 3 clusters
- The consensus was NOT generated by running SPOA on 250 reads - it was generated by merging three existing consensus sequences using IUPAC codes and size-weighted MSA-based consensus generation

The number `250` represents **total supporting evidence**, not "reads used for consensus generation."

### The rawric Field: Making Merging Transparent

The `rawric=100+89+61` field shows:
- This consensus was created by merging **3 separate variants**
- The original variants had RiC values of 100, 89, and 61 (shown largest-first)
- Total supporting reads: 250 (sum of the above)
- You can assess the **quality distribution**

## Interpreting rawric Values

Understanding the quality distribution helps you assess confidence in merged consensuses:

**Balanced merge - High confidence:**
```
rawric=60+55+50  (ric=165)
```
Three similar-quality variants merged. Each had strong support independently (50+). Strong evidence this represents real biological variation.

**Acceptable merge - Good quality:**
```
rawric=30+20  (ric=50)
```
Two medium-quality consensuses. Both components have decent support (30, 20).

**Dominated merge - Scrutinize more carefully:**
```
rawric=100+8+5  (ric=113)
```
One strong variant (100) plus two weak ones (8, 5). The merged consensus is mainly based on the first variant. The weak variants were less prominent in the source data.

**Questionable merge - Review needed:**
```
rawric=6+5+4+3  (ric=18, snp=2)
```
Four relatively weak variants (all <10). Even though total ric=18 seems okay, none of the individual haplotypes has strong support.

**Missing rawric - Single variant:**
```
size=113 ric=100 primers=ITS1F,ITS4
```
No merging occurred. This is a straightforward consensus from one cluster.

## Understanding the Philosophy: Ambiguity Codes as Information

This might seem like a technical detail, but it's worth understanding the conceptual approach:

### Traditional View: Ambiguity = Uncertainty

In many bioinformatics contexts, IUPAC ambiguity codes (R, Y, W, etc.) represent **uncertainty** - less information:
- "I'm not sure if this position is A or G, so I'll call it R"
- Ambiguity codes are often seen as lower quality

### Speconsense Approach: Ambiguity = Summarized Variation

In speconsense-summarize, we use IUPAC codes to represent **known variation** - *more* information:
- "I have strong evidence for both A and G alleles in the sample, so I'll call it R"
- The code R tells you that you have **two distinct haplotypes** present
- This is actually *additional information* about biological diversity, not uncertainty

### Why This Matters

When speconsense-summarize merges variants that differ by SNPs:
- It's **preserving information** about within-specimen variation
- It's **summarizing multiple variants** into one sequence using IUPAC codes
- More reads are needed to confidently call both alleles

This is why `rawric` can exceed `--max-sample-size`: you need sufficient reads for **each haplotype** (e.g., 3 haplotypes × 50 reads each = 150 total), plus enough to detect the variants between them.

### Open Science and Reproducibility

An important principle guiding this design is **sufficiency for reproduction**. The FASTQ file, combined with the published methodology on [protocols.io](https://dx.doi.org/10.17504/protocols.io.dm6gpbm88lzp/v4), should be sufficient for anyone to reproduce the FASTA consensus sequences.

This means:
- **All supporting reads must be preserved** in the FASTQ files (not subsampled after merging)
- **The processing steps must be transparent** through the header fields
- **The methodology must be fully documented** and publicly accessible

The `rawric` field supports this principle by:
1. Making it clear that merging occurred (not hiding the multi-step process)
2. Showing the quality of each component (enabling assessment of the merge decision)
3. Preserving all reads in the FASTQ (maintaining the evidence trail)

Someone receiving your FASTA and FASTQ files could:
- See from `rawric=100+89+61` that three consensuses were merged
- Access all 250 reads from the FASTQ file
- Follow the published protocols.io methodology to understand how the merge was performed
- Reproduce your results or re-analyze with different parameters

This commitment to reproducibility is essential for community science and open mycology work.

## Practical Implications

### When Should You Be Concerned?

**✓ Expected and fine:**
```
rawric=65+60+55  (balanced, all strong)
rawric=80+75  (two similar, both strong)
```

**⚠ Review carefully:**
```
rawric=100+12+8  (dominated by one cluster)
rawric=18+15+12+10+9+8  (many weaker clusters)
```

In dominated merges, the weak variants have less support. You may want to confirm that they make biological sense.

### Adjusting Your Workflow

**If you want conservative merging:**
```bash
# No SNP merging
speconsense-summarize --merge-position-count 0

# Higher quality threshold per haplotype
speconsense-summarize --min-ric 20  # Only use variants with ric ≥ 20
```

**If you want to capture variation:**
```bash
# More permissive SNP/indel merging
speconsense-summarize --merge-position-count 3 --merge-indel-length 2

# Allow more variants per specimen
speconsense-summarize --select-max-variants 3
```

## What About --max-sample-size?

### Current Semantics

`--max-sample-size=100` in speconsense means:
- "For each cluster, use at most 100 reads to generate its consensus"
- Prevents SPOA from running on huge clusters (which is slow)
- Ensures manageable FASTQ file sizes in debug output

### After Merging

When speconsense-summarize merges variants:
- The combined FASTQ file can exceed 100 reads
- This is by design: you want all the supporting evidence
- The `rawric` field makes this transparent

### Edge Case: When Merging Is Required

Consider a specimen with 4 real haplotypes, where you're using a stricter sampling limit to manage computational load:
- Each haplotype needs ~20 reads for decent quality
- The variants happen to have 25, 22, 20, and 18 reads (all below the `--max-sample-size=50` threshold)
- Merged total: 25 + 22 + 20 + 18 = 85 reads

In this case, the merged consensus with `rawric=25+22+20+18` (ric=85) actually represents the minimum viable evidence for resolving 4 variants. The total exceeding `--max-sample-size` is **expected** because you're representing more biological information (4 haplotypes rather than 1).

## Raw Variant Files

When merging occurs, speconsense-summarize outputs both the merged consensus and the individual pre-merge variants as `.raw` files:

**Merged consensus:**
```
specimen-1-RiC250.fasta
>specimen-1 size=497 ric=250 rawric=100+89+61 snp=2
```

**Raw pre-merge variants:**
```
specimen-1.raw1-RiC100.fasta
specimen-1.raw2-RiC89.fasta
specimen-1.raw3-RiC61.fasta
```

The `.raw` files preserve the individual unmerged sequences, allowing you to:
- Inspect the original variants before merging
- Verify the merge was appropriate
- Use individual variants for downstream analysis if preferred
- Trace back to the original speconsense clustering results

## Common Questions

### Why not resample to keep --max-sample-size limit?

We could randomly (or proportionally) sample 100 reads from the 250 total, but then:
- The FASTQ file wouldn't contain all the evidence
- You couldn't verify which reads contributed
- Information would be lost
- Reproducibility would be compromised

Better to keep all reads and make the merging transparent with `rawric`.

### Can I reconstruct the pre-merge consensuses?

Yes! The `.raw` FASTA files contain the individual pre-merge consensus sequences, and their corresponding `.raw` FASTQ files contain the reads that contributed to each one.

### Should I always merge SNPs?

It depends on your goals:

**Yes, merge if:**
- You want to represent within-specimen variation compactly
- You're okay with IUPAC codes in your consensus
- You want a single representative sequence per specimen

**No, don't merge if:**
- You want clean, unambiguous sequences
- You prefer separate consensuses for each haplotype
- You'll handle variants downstream in your analysis

Use `--merge-position-count 0` to disable SNP merging entirely.

## Summary

The `rawric` field addresses the RiC interpretation issue by:
- Showing which consensuses are merged (vs single-variant)
- Revealing the quality distribution across merged components
- Maintaining self-contained, meaningful headers
- Preserving all supporting evidence in FASTQ files
- Supporting reproducibility by making the processing transparent

This approach aligns with the philosophy of using IUPAC codes to represent **biological variation** (more information) rather than uncertainty (less information), while giving you the transparency to assess consensus quality accurately.
